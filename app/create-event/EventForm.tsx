"use client";

import React, { useState, useEffect } from 'react';
// Material UI imports
import { Box, CircularProgress, Grid, MenuItem, Paper, Typography } from '@mui/material';
import TextField from '@mui/material/TextField';
import Button from '@mui/material/Button';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { MobileDateTimePicker } from '@mui/x-date-pickers/MobileDateTimePicker';
import { renderTimeViewClock } from '@mui/x-date-pickers/timeViewRenderers';

// Until I have a better way, MUI-X DateTimePicker
import dayjs, { Dayjs } from 'dayjs';
import isLeapYear from 'dayjs/plugin/isLeapYear';

import 'dayjs/locale/en'; // import locale
import type { User } from '@prisma/client';

// Action to handle Prisma database call
import { createEvent } from './createEventAction';

// Map Stuff
import { useGeolocated } from "react-geolocated";
import {APIProvider, Map, AdvancedMarker, Pin, InfoWindow} from '@vis.gl/react-google-maps';

dayjs.extend(isLeapYear) // use plugin
dayjs.locale('en') // use locale

// Should mimick db Event Model
interface CreateEventFormData {
  name: string;
  description: string;
  activity: Activity;
  lat: number;
  lng: number;
  startTime: Dayjs;
  endTime: Dayjs;
}

// Passes in db model of User from parent
interface EventFormProps {
    user: User;
}

// Activity Interface
interface Activity {
    name: string;
    value: string;
}

// location Interface
interface LatLngLoc {
    lat: number,
    lng: number
}

// Activities
const activities: Activity[] = [
    {name: "Soccer", value: "soccer"},
    {name: "Basketball", value: "basketball"},
    {name: "Football", value: "football"},
    {name: "Baseball", value: "baseball"},
    {name: "Volleyball", value: "volleyball"},
    {name: "Lacrosse", value: "lacrosse"},
    {name: "Ultimate Frisbee", value: "ultimatefrisbee"},
    {name: "Skateboarding", value: "skateboarding"},
    {name: "Running", value: "running"},
    {name: "Tennis", value: "tennis"},
    {name: "Cricket", value: "cricket"},
    {name: "Field Hockey", value: "fieldhockey"},
    {name: "Badminton", value: "badminton"},
    {name: "Table Tennis", value: "tabletennis"},
    {name: "Chess", value: "chess"},
    {name: "Checkers", value: "checkers"},
    {name: "Magic The Gathering", value: "magic"},
    {name: "Warhammer", value: "warhammer"},
    {name: "Video Game (See Desc)", value: "videogame"},
    {name: "Other (See Desc)", value: "other"},
];


export default function EventForm({ user }: EventFormProps) {
    const { coords,
            isGeolocationAvailable,
            isGeolocationEnabled,
         } =
        useGeolocated({
            positionOptions: {
                enableHighAccuracy: false,
            },
            userDecisionTimeout: 5000,
            watchLocationPermissionChange: true,
            watchPosition: true,
        });
    console.log(`COORDS: ${coords?.latitude}, ${coords?.longitude}`);

    // Form values and their useState declarations
    const [name, setName ] = useState<string>();
    const [description, setDescription ] = useState<string>();
    const [activity, setActivity ] = useState<string>("soccer");
    const [latLng, setLatLng] = useState<LatLngLoc>();
    const [startTime, setStartTime] = useState<Dayjs>();
    const [endTime, setEndTime] = useState<Dayjs>();

    
    // Field Handlers
    const handleNameChange = (
        event: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
    ) => {
        setName(event.target.value);        
    };

    const handleDescriptionChange = (
        event: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
    ) => {
        setDescription(event.target.value);        
    };

    const handleActivityChange = (
        event: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
    ) => {
        setActivity(event.target.value);        
    };    

    const handleStartTimeChange = (date: Dayjs | null) => {
        if (date) {
        setStartTime(date);
        }
    };

    const handleEndTimeChange = (date: Dayjs | null) => {
        if (date) {
        setEndTime(date);
        }
    };

    const handleMapClick = (event: any) => {
        const {lat, lng } = event.detail.latLng;
        setLatLng(event.detail.latLng);
    }

    const handleSubmit = (event: React.FormEvent) => {
        event.preventDefault();
        //create event
        const newEvent = {
            // id is autogenerated
            //id:Date.now(),
            name: name,
            description: description,
            lat: latLng?.lat,
            lng: latLng?.lng,
            owner: user.id,
            activity: activity,
            attendance: [],
            createdAt: new Date(),
            startTime: startTime?.toDate(),
            endTime: endTime?.toDate()
        }

        createEvent(newEvent);

    };

    return (!isGeolocationAvailable || !isGeolocationEnabled) ? (
            <Typography variant="h3">
                Please enable location!
            </Typography>
            ): 
        
        coords ? (
            <Grid container  spacing={2}>            
                <Grid container item xs={6}>
                    <Paper sx={{flexGrow: 1}} elevation={6}>
                    <Grid item xs={12}>
                        <TextField
                            label="Name"
                            name="name"
                            variant="standard"
                            value={name}
                            onChange={handleNameChange}
                            margin="normal"
                            helperText="Name your activity"
                            required
                        />
                    </Grid>
                    <Grid item xs={12}>
                        <TextField
                            id="activitySelect"
                            name="activity"
                            variant="standard"
                            select
                            margin="normal"
                            onChange={handleActivityChange}
                            required
                            label="Activity"
                            helperText="Please select the activity"
                            defaultValue={activity}
                        >
                            {activities.map((option) => (
                                <MenuItem key={option.value} value={option.value}>
                                {option.name}
                                </MenuItem>
                            ))}
                        </TextField>
                    </Grid>
                    <Grid item xs={12}>
                        <TextField
                            label="Description"
                            name="description"
                            variant="standard"
                            helperText="Describe the activity with a few details"
                            value={description}
                            onChange={handleDescriptionChange}
                            fullWidth
                            required
                            margin="normal"
                        />
                    </Grid>
                    <Grid item xs={12}>
                        <TextField
                            label="Latitude"
                            name="lat"
                            type="number"
                            variant="standard"
                            helperText="Latitude of the activity location"
                            fullWidth
                            required
                            value={latLng?.lat}
                            margin="normal"
                            InputLabelProps={{ shrink: true }}
                            InputProps={{
                                readOnly: true,
                              }}
                            
                        />
                        <TextField
                            label="Longitude"
                            name="lng"
                            type="number"
                            variant="standard"
                            helperText="Longitude of the activity location"
                            value={latLng?.lng}
                            fullWidth
                            required
                            margin="normal"
                            InputLabelProps={{ shrink: true }}
                            InputProps={{
                                readOnly: true,
                              }}
                        />
                    </Grid>
                    <LocalizationProvider dateAdapter={AdapterDayjs}>
                    <Grid item xs={12}>
                        <MobileDateTimePicker
                            label="Start Time"
                            value={startTime}
                            disablePast
                            formatDensity='spacious'
                            onChange={(date) => handleStartTimeChange(date)}
                            viewRenderers={{
                                hours: renderTimeViewClock,
                                minutes: renderTimeViewClock,
                                seconds: null,
                            }}                 
                        />
                    </Grid>
                    <Grid item xs={12}>
                        <MobileDateTimePicker
                            label="End Time"
                            value={endTime}
                            disablePast
                            formatDensity='spacious'
                            onChange={(date) => handleEndTimeChange(date)}
                            viewRenderers={{
                                hours: renderTimeViewClock,
                                minutes: renderTimeViewClock,
                                seconds: null,
                            }}
                        />
                    </Grid>
                    </LocalizationProvider>
                        <Grid item xs={12}>
                            <Button onClick={handleSubmit} variant="contained" color="primary">
                                Create Event
                            </Button>
                        </Grid>
                    </Paper>
                </Grid>            
                
                <Grid item xs={6}>
                    <Paper elevation={6}>                    
                        <APIProvider apiKey={process.env.NEXT_PUBLIC_GMAPS_API_KEY as string}>
                            <div style={{height: '100vh', width: '100%'}}> 
                            <Map onClick={handleMapClick} zoom={15} center={{lat:coords.latitude,lng: coords.longitude}} 
                                mapId={process.env.NEXT_PUBLIC_GMAPS_MAP_ID}>
                                { latLng && 
                                    <AdvancedMarker position={latLng}>
                                        <Pin />
                                    </AdvancedMarker> 
                                }
                            </Map>
                            </div>
                        </APIProvider>
                    </Paper>
                </Grid>            
            </Grid> 
        ): <CircularProgress />;
    
}
